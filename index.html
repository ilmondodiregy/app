<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestione">
    <meta name="theme-color" content="#f8fafc">
    <title>Gestione Ordini, Spese e Scorte</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
        }
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
        * {
            -webkit-tap-highlight-color: transparent;
        }
        .thumbnail-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.375rem;
        }
        .lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 2rem;
        }
        .lightbox img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .drag-active {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Custom Hook: useLocalStorage
        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.error(error);
                }
            };

            return [storedValue, setValue];
        }

        // Types/Enums
        const OrderStatus = {
            DaIniziare: 'Da Iniziare',
            InSvolgimento: 'In Svolgimento',
            Terminato: 'Terminato',
        };

        // Utility functions for image handling
        const resizeImage = (file, maxWidth, maxHeight) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        // Icons
        const PlusIcon = () => (
            <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
            </svg>
        );

        const EditIcon = () => (
            <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" />
            </svg>
        );

        const TrashIcon = () => (
            <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const CloseIcon = () => (
            <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const SearchIcon = () => (
            <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );

        const XCircleIcon = () => (
            <svg className="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const LinkIcon = () => (
            <svg className="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
        );

        const CopyIcon = () => (
            <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
        );

        const CameraIcon = () => (
            <svg className="h-8 w-8 mx-auto text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        const MinusIcon = () => (
            <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M20 12H4" />
            </svg>
        );

        const PlusSmallIcon = () => (
            <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
            </svg>
        );
        
        const FileDownloadIcon = () => (
            <svg className="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const ExportButtons = ({ onExportExcel, onExportPdf, disabled }) => (
            <div className="flex justify-end items-center gap-2 mb-6">
                <button
                    onClick={onExportExcel}
                    disabled={disabled}
                    className="inline-flex items-center rounded-md border border-transparent bg-green-100 px-3 py-2 text-sm font-medium leading-4 text-green-800 hover:bg-green-200 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed"
                >
                    <FileDownloadIcon />
                    Esporta Excel
                </button>
                <button
                    onClick={onExportPdf}
                    disabled={disabled}
                    className="inline-flex items-center rounded-md border border-transparent bg-red-100 px-3 py-2 text-sm font-medium leading-4 text-red-800 hover:bg-red-200 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed"
                >
                    <FileDownloadIcon />
                    Esporta PDF
                </button>
            </div>
        );

        // FilterControls Component (Orders)
        const FilterControls = ({ searchTerm, setSearchTerm, statusFilter, setStatusFilter, startDate, setStartDate, endDate, setEndDate }) => {
            const handleReset = () => {
                setSearchTerm('');
                setStatusFilter('all');
                setStartDate('');
                setEndDate('');
            };

            const isFiltered = searchTerm || statusFilter !== 'all' || startDate || endDate;

            return (
                <div className="bg-white p-4 rounded-lg shadow mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div className="lg:col-span-2">
                            <label htmlFor="search" className="block text-sm font-medium text-slate-700">Cerca Cliente o Articolo</label>
                            <div className="relative mt-1">
                                <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                                    <SearchIcon />
                                </div>
                                <input
                                    type="text"
                                    id="search"
                                    placeholder="Cerca..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="block w-full rounded-md border-slate-300 py-2 pl-10 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border"
                                />
                            </div>
                        </div>
                        <div>
                            <label htmlFor="statusFilter" className="block text-sm font-medium text-slate-700">Stato</label>
                            <select
                                id="statusFilter"
                                value={statusFilter}
                                onChange={(e) => setStatusFilter(e.target.value)}
                                className="mt-1 block w-full rounded-md border-slate-300 py-2 pl-3 pr-10 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border"
                            >
                                <option value="all">Tutti gli stati</option>
                                {Object.values(OrderStatus).map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                        </div>
                        <div className="grid grid-cols-2 gap-2 md:col-span-2 lg:col-span-1">
                            <div>
                                <label htmlFor="startDate" className="block text-sm font-medium text-slate-700">Da</label>
                                <input
                                    type="date"
                                    id="startDate"
                                    value={startDate}
                                    onChange={(e) => setStartDate(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border"
                                />
                            </div>
                            <div>
                                <label htmlFor="endDate" className="block text-sm font-medium text-slate-700">A</label>
                                <input
                                    type="date"
                                    id="endDate"
                                    value={endDate}
                                    onChange={(e) => setEndDate(e.target.value)}
                                    min={startDate}
                                    className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm border"
                                />
                            </div>
                        </div>
                    </div>
                    {isFiltered && (
                        <div className="mt-4 flex justify-end">
                            <button
                                onClick={handleReset}
                                className="inline-flex items-center rounded-md border border-transparent bg-slate-100 px-3 py-2 text-sm font-medium leading-4 text-slate-700 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2"
                            >
                                <XCircleIcon />
                                Resetta Filtri
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // ExpenseFilterControls Component
        const ExpenseFilterControls = ({ searchTerm, setSearchTerm, startDate, setStartDate, endDate, setEndDate }) => {
            const handleReset = () => {
                setSearchTerm('');
                setStartDate('');
                setEndDate('');
            };

            const isFiltered = searchTerm || startDate || endDate;

            return (
                <div className="bg-white p-4 rounded-lg shadow mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                        <div>
                            <label htmlFor="search-expense" className="block text-sm font-medium text-slate-700">Cerca Descrizione</label>
                            <div className="relative mt-1">
                                <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                                    <SearchIcon />
                                </div>
                                <input
                                    type="text"
                                    id="search-expense"
                                    placeholder="Cerca..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="block w-full rounded-md border-slate-300 py-2 pl-10 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm border"
                                />
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <div>
                                <label htmlFor="startDate-expense" className="block text-sm font-medium text-slate-700">Da</label>
                                <input
                                    type="date"
                                    id="startDate-expense"
                                    value={startDate}
                                    onChange={(e) => setStartDate(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm border"
                                />
                            </div>
                            <div>
                                <label htmlFor="endDate-expense" className="block text-sm font-medium text-slate-700">A</label>
                                <input
                                    type="date"
                                    id="endDate-expense"
                                    value={endDate}
                                    onChange={(e) => setEndDate(e.target.value)}
                                    min={startDate}
                                    className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm border"
                                />
                            </div>
                        </div>
                    </div>
                    {isFiltered && (
                        <div className="mt-4 flex justify-end">
                            <button
                                onClick={handleReset}
                                className="inline-flex items-center rounded-md border border-transparent bg-slate-100 px-3 py-2 text-sm font-medium leading-4 text-slate-700 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2"
                            >
                                <XCircleIcon />
                                Resetta Filtri
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // StockFilterControls Component
        const StockFilterControls = ({ 
            searchTerm, setSearchTerm, 
            startDate, setStartDate, 
            endDate, setEndDate,
            quantityFilter, setQuantityFilter,
            hasImage, setHasImage
        }) => {
            const handleReset = () => {
                setSearchTerm('');
                setStartDate('');
                setEndDate('');
                setQuantityFilter('all');
                setHasImage('all');
            };

            const isFiltered = searchTerm || startDate || endDate || quantityFilter !== 'all' || hasImage !== 'all';

            return (
                <div className="bg-white p-4 rounded-lg shadow mb-6">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                        <div className="lg:col-span-2">
                            <label htmlFor="search-stock" className="block text-sm font-medium text-slate-700">Cerca Codice o Descrizione</label>
                            <div className="relative mt-1">
                                <div className="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400">
                                    <SearchIcon />
                                </div>
                                <input
                                    type="text"
                                    id="search-stock"
                                    placeholder="Cerca..."
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="block w-full rounded-md border-slate-300 py-2 pl-10 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm border"
                                />
                            </div>
                        </div>
                        <div>
                            <label htmlFor="quantityFilter" className="block text-sm font-medium text-slate-700">Quantità</label>
                            <select
                                id="quantityFilter"
                                value={quantityFilter}
                                onChange={(e) => setQuantityFilter(e.target.value)}
                                className="mt-1 block w-full rounded-md border-slate-300 py-2 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm border"
                            >
                                <option value="all">Tutte</option>
                                <option value="zero">Esauriti (0)</option>
                                <option value="one">Pezzo singolo (1)</option>
                                <option value="low">Sotto soglia (&lt;5)</option>
                                <option value="available">Disponibili (&gt;0)</option>
                            </select>
                        </div>
                        <div>
                            <label htmlFor="hasImage" className="block text-sm font-medium text-slate-700">Immagine</label>
                            <select
                                id="hasImage"
                                value={hasImage}
                                onChange={(e) => setHasImage(e.target.value)}
                                className="mt-1 block w-full rounded-md border-slate-300 py-2 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm border"
                            >
                                <option value="all">Tutte</option>
                                <option value="with">Con immagine</option>
                                <option value="without">Senza immagine</option>
                            </select>
                        </div>
                        <div className="grid grid-cols-2 gap-2">
                            <div>
                                <label htmlFor="startDate-stock" className="block text-sm font-medium text-slate-700">Da</label>
                                <input
                                    type="date"
                                    id="startDate-stock"
                                    value={startDate}
                                    onChange={(e) => setStartDate(e.target.value)}
                                    className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm border"
                                />
                            </div>
                            <div>
                                <label htmlFor="endDate-stock" className="block text-sm font-medium text-slate-700">A</label>
                                <input
                                    type="date"
                                    id="endDate-stock"
                                    value={endDate}
                                    onChange={(e) => setEndDate(e.target.value)}
                                    min={startDate}
                                    className="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm border"
                                />
                            </div>
                        </div>
                    </div>
                    {isFiltered && (
                        <div className="mt-4 flex justify-end">
                            <button
                                onClick={handleReset}
                                className="inline-flex items-center rounded-md border border-transparent bg-slate-100 px-3 py-2 text-sm font-medium leading-4 text-slate-700 hover:bg-slate-200 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2"
                            >
                                <XCircleIcon />
                                Resetta Filtri
                            </button>
                        </div>
                    )}
                </div>
            );
        };

        // ImageLightbox Component
        const ImageLightbox = ({ imageUrl, onClose, metadata }) => {
            useEffect(() => {
                const handleEscape = (e) => {
                    if (e.key === 'Escape') onClose();
                };
                document.addEventListener('keydown', handleEscape);
                return () => document.removeEventListener('keydown', handleEscape);
            }, [onClose]);

            return (
                <div className="lightbox" onClick={onClose}>
                    <div className="relative">
                        <button
                            onClick={onClose}
                            className="absolute -top-12 right-0 text-white hover:text-slate-300 p-2"
                        >
                            <CloseIcon />
                        </button>
                        <img src={imageUrl} alt="Ingrandimento" onClick={(e) => e.stopPropagation()} />
                        {metadata && (
                            <div className="absolute bottom-0 left-0 right-0 bg-black bg-opacity-70 text-white p-4 text-sm">
                                {metadata}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // StockForm Component
        const StockForm = ({ onSave, onCancel, initialStock, existingCodes }) => {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [codice, setCodice] = useState('');
            const [descrizione, setDescrizione] = useState('');
            const [quantity, setQuantity] = useState(1);
            const [price, setPrice] = useState('');
            const [thumbnail, setThumbnail] = useState('');
            const [fullImage, setFullImage] = useState('');
            const [dragActive, setDragActive] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (initialStock) {
                    setDate(initialStock.date);
                    setCodice(initialStock.codice);
                    setDescrizione(initialStock.descrizione);
                    setQuantity(initialStock.quantity);
                    setPrice(initialStock.price || '');
                    setThumbnail(initialStock.thumbnail || '');
                    setFullImage(initialStock.fullImage || '');
                }
            }, [initialStock]);

            const handleImageUpload = async (file) => {
                if (!file || !file.type.startsWith('image/')) {
                    alert('Seleziona un file immagine valido');
                    return;
                }

                try {
                    const thumb = await resizeImage(file, 150, 150);
                    const full = await resizeImage(file, 1200, 1200);
                    setThumbnail(thumb);
                    setFullImage(full);
                } catch (error) {
                    console.error('Errore nel ridimensionamento immagine:', error);
                    alert('Errore nel caricamento immagine');
                }
            };

            const handleDrag = (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            };

            const handleDrop = (e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);

                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    handleImageUpload(e.dataTransfer.files[0]);
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();

                if (!date || !codice || !descrizione || quantity === '' || isNaN(quantity)) {
                    alert('Per favore, compila tutti i campi obbligatori.');
                    return;
                }

                if (!initialStock && existingCodes.includes(codice.toUpperCase())) {
                    if (!confirm(`Il codice "${codice}" esiste già. Vuoi creare comunque un nuovo movimento?`)) {
                        return;
                    }
                }

                const stockData = {
                    date,
                    codice: codice.toUpperCase(),
                    descrizione,
                    quantity: Number(quantity),
                    price: price === '' ? null : Number(price),
                    thumbnail,
                    fullImage,
                };

                if (initialStock) {
                    onSave({ ...stockData, id: initialStock.id });
                } else {
                    onSave(stockData);
                }
            };

            const formTitle = initialStock ? 'Modifica Movimento' : 'Nuovo Movimento';
            const total = (quantity !== '' && price !== '' && !isNaN(quantity) && !isNaN(price))
                ? (Number(quantity) * Number(price)).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                : '—';

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-2xl max-h-full overflow-y-auto">
                        <div className="flex justify-between items-center p-5 border-b border-slate-200">
                            <h2 className="text-xl font-semibold">{formTitle}</h2>
                            <button onClick={onCancel} className="p-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100">
                                <CloseIcon />
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-5 space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="date" className="block text-sm font-medium text-slate-700">Data *</label>
                                    <input
                                        type="date"
                                        id="date"
                                        value={date}
                                        onChange={e => setDate(e.target.value)}
                                        required
                                        className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="codice" className="block text-sm font-medium text-slate-700">
                                        Codice * {initialStock && <span className="text-xs text-slate-500">(non modificabile)</span>}
                                    </label>
                                    <input
                                        type="text"
                                        id="codice"
                                        value={codice}
                                        onChange={e => setCodice(e.target.value)}
                                        disabled={!!initialStock}
                                        required
                                        className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm disabled:bg-slate-100"
                                    />
                                </div>
                            </div>
                            <div>
                                <label htmlFor="descrizione" className="block text-sm font-medium text-slate-700">Descrizione *</label>
                                <input
                                    type="text"
                                    id="descrizione"
                                    value={descrizione}
                                    onChange={e => setDescrizione(e.target.value)}
                                    required
                                    className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                                />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="quantity" className="block text-sm font-medium text-slate-700">Quantità *</label>
                                    <input
                                        type="number"
                                        id="quantity"
                                        value={quantity}
                                        onChange={e => setQuantity(e.target.value === '' ? '' : Number(e.target.value))}
                                        required
                                        className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                                    />
                                    <p className="mt-1 text-xs text-slate-500">Usa numeri negativi per scarichi</p>
                                </div>
                                <div>
                                    <label htmlFor="price" className="block text-sm font-medium text-slate-700">Prezzo (€)</label>
                                    <input
                                        type="number"
                                        id="price"
                                        value={price}
                                        onChange={e => setPrice(e.target.value)}
                                        min="0"
                                        step="0.01"
                                        placeholder="Opzionale"
                                        className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                                    />
                                </div>
                            </div>
                            <div className="p-3 bg-purple-50 rounded-md text-right">
                                <span className="text-sm font-medium text-slate-600">Totale riga: </span>
                                <span className="text-xl font-bold text-slate-900">€ {total}</span>
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-2">Immagine</label>
                                <div
                                    className={`border-2 border-dashed rounded-lg p-6 text-center ${dragActive ? 'drag-active' : 'border-slate-300'}`}
                                    onDragEnter={handleDrag}
                                    onDragLeave={handleDrag}
                                    onDragOver={handleDrag}
                                    onDrop={handleDrop}
                                >
                                    {thumbnail ? (
                                        <div className="space-y-3">
                                            <img src={thumbnail} alt="Preview" className="mx-auto rounded-lg" style={{maxWidth: '150px'}} />
                                            <div className="flex justify-center gap-2">
                                                <button
                                                    type="button"
                                                    onClick={() => fileInputRef.current?.click()}
                                                    className="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700"
                                                >
                                                    Cambia
                                                </button>
                                                <button
                                                    type="button"
                                                    onClick={() => { setThumbnail(''); setFullImage(''); }}
                                                    className="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700"
                                                >
                                                    Rimuovi
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            <CameraIcon />
                                            <p className="text-sm text-slate-600">Trascina un'immagine qui o</p>
                                            <button
                                                type="button"
                                                onClick={() => fileInputRef.current?.click()}
                                                className="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700"
                                            >
                                                Seleziona File
                                            </button>
                                        </div>
                                    )}
                                    <input
                                        ref={fileInputRef}
                                        type="file"
                                        accept="image/*"
                                        capture="environment"
                                        onChange={(e) => e.target.files?.[0] && handleImageUpload(e.target.files[0])}
                                        className="hidden"
                                    />
                                </div>
                            </div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50"
                                >
                                    Annulla
                                </button>
                                <button
                                    type="submit"
                                    className="px-4 py-2 bg-purple-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-purple-700"
                                >
                                    Salva
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // StockItem Component
        const StockItem = ({ stock, onEdit, onDelete, onDuplicate, onAdjustQuantity, onImageClick }) => {
            const formatCurrency = (value) => {
                if (value === null || value === undefined) return '—';
                return value.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
            };

            const formattedDate = new Date(stock.date).toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
            });

            const total = (stock.price !== null && stock.price !== undefined) 
                ? stock.quantity * stock.price 
                : null;

            const quantityColor = stock.quantity > 0 ? 'text-green-600' : 'text-red-600';

            return (
                <div className="bg-white rounded-lg shadow-md overflow-hidden transition-shadow duration-300 hover:shadow-xl">
                    <div className="p-5">
                        <div className="flex justify-between items-start gap-4">
                            <div className="flex-1">
                                <div className="flex items-start gap-3">
                                    {stock.thumbnail && (
                                        <img
                                            src={stock.thumbnail}
                                            alt={stock.descrizione}
                                            className="thumbnail-image cursor-pointer hover:opacity-80 transition"
                                            onClick={() => onImageClick(stock.fullImage || stock.thumbnail)}
                                        />
                                    )}
                                    <div className="flex-1">
                                        <h3 className="text-lg font-bold text-slate-800">{stock.codice}</h3>
                                        <p className="text-slate-600">{stock.descrizione}</p>
                                        <p className="text-sm text-slate-500 mt-1">{formattedDate}</p>
                                    </div>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className={`text-2xl font-bold ${quantityColor}`}>{stock.quantity}</p>
                                <p className="text-xs text-slate-500">mov.</p>
                            </div>
                        </div>
                         <div className="mt-4 border-t border-slate-200 pt-4">
                            <div className="grid grid-cols-2 gap-4 text-center md:text-left">
                                <div>
                                    <p className="text-sm text-slate-500">Prezzo Unitario</p>
                                    <p className="font-semibold text-slate-800">{formatCurrency(stock.price)}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-slate-500">Valore Movimento</p>
                                    <p className="font-bold text-slate-900">{formatCurrency(total)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="bg-slate-50 px-5 py-3 flex justify-end items-center">
                        <div className="flex space-x-2">
                            <button
                                onClick={() => onDuplicate(stock)}
                                className="p-2 text-slate-500 hover:text-slate-700 hover:bg-slate-200 rounded-full transition-colors"
                                title="Duplica"
                            >
                                <CopyIcon />
                            </button>
                            <button
                                onClick={() => onEdit(stock)}
                                className="p-2 text-slate-500 hover:text-slate-700 hover:bg-slate-200 rounded-full transition-colors"
                                title="Modifica"
                            >
                                <EditIcon />
                            </button>
                            <button
                                onClick={() => onDelete(stock.id)}
                                className="p-2 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-full transition-colors"
                                title="Elimina"
                            >
                                <TrashIcon />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // StockList Component
        const StockList = ({ stocks, onEdit, onDelete, onDuplicate, onAdjustQuantity, onImageClick }) => {
            return (
                <div className="space-y-4">
                    {stocks.map(stock => (
                        <StockItem
                            key={stock.id}
                            stock={stock}
                            onEdit={onEdit}
                            onDelete={onDelete}
                            onDuplicate={onDuplicate}
                            onAdjustQuantity={onAdjustQuantity}
                            onImageClick={onImageClick}
                        />
                    ))}
                </div>
            );
        };

        // StocksView Component
        const StocksView = ({ stocks, setStocks }) => {
            const [isFormVisible, setIsFormVisible] = useState(false);
            const [editingStock, setEditingStock] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');
            const [quantityFilter, setQuantityFilter] = useState('all');
            const [hasImage, setHasImage] = useState('all');
            const [lightboxImage, setLightboxImage] = useState(null);
            const [undoStack, setUndoStack] = useState([]);

            const handleSaveStock = (stockToSave) => {
                if ('id' in stockToSave) {
                    setStocks(stocks.map(s => s.id === stockToSave.id ? stockToSave : s));
                } else {
                    const newStock = {
                        ...stockToSave,
                        id: new Date().toISOString() + Math.random(),
                    };
                    setStocks([...stocks, newStock]);
                }
                closeForm();
            };

            const handleDeleteStock = (id) => {
                const stockToDelete = stocks.find(s => s.id === id);
                if (window.confirm(`Sei sicuro di voler eliminare il movimento per "${stockToDelete?.codice}"?`)) {
                    const newStocks = stocks.filter(s => s.id !== id);
                    setUndoStack([...undoStack, { action: 'delete', stock: stockToDelete }]);
                    setStocks(newStocks);
                    
                    setTimeout(() => {
                        setUndoStack(stack => stack.filter(item => item.stock.id !== id));
                    }, 5000);
                }
            };

            const handleUndo = () => {
                if (undoStack.length === 0) return;
                const lastAction = undoStack[undoStack.length - 1];
                if (lastAction.action === 'delete') {
                    setStocks([...stocks, lastAction.stock]);
                }
                setUndoStack(undoStack.slice(0, -1));
            };

            const handleEditStock = (stock) => {
                setEditingStock(stock);
                setIsFormVisible(true);
            };

            const handleDuplicateStock = (stock) => {
                const duplicate = {
                    ...stock,
                    id: undefined,
                    date: new Date().toISOString().split('T')[0],
                };
                setEditingStock(duplicate);
                setIsFormVisible(true);
            };

            const openForm = () => {
                setEditingStock(null);
                setIsFormVisible(true);
            };

            const closeForm = () => {
                setIsFormVisible(false);
                setEditingStock(null);
            };
            
            // Calculate aggregated stock by code
            const stockByCode = {};
            stocks.forEach(stock => {
                const code = stock.codice.toUpperCase();
                if (!stockByCode[code]) {
                    stockByCode[code] = {
                        codice: stock.codice,
                        descrizione: stock.descrizione,
                        totalQuantity: 0,
                        thumbnail: stock.thumbnail,
                        fullImage: stock.fullImage
                    };
                }
                stockByCode[code].totalQuantity += stock.quantity;
                if(stock.thumbnail) stockByCode[code].thumbnail = stock.thumbnail;
                if(stock.fullImage) stockByCode[code].fullImage = stock.fullImage;
            });

            const filteredAndAggregatedStocks = Object.values(stockByCode).filter(stock => {
                const searchTermLower = searchTerm.toLowerCase();
                const matchesSearch = searchTermLower === '' ||
                    stock.codice.toLowerCase().includes(searchTermLower) ||
                    stock.descrizione.toLowerCase().includes(searchTermLower);

                const matchesQuantity = 
                    quantityFilter === 'all' ||
                    (quantityFilter === 'zero' && stock.totalQuantity === 0) ||
                    (quantityFilter === 'one' && stock.totalQuantity === 1) ||
                    (quantityFilter === 'low' && stock.totalQuantity > 0 && stock.totalQuantity < 5) ||
                    (quantityFilter === 'available' && stock.totalQuantity > 0);

                const matchesImage = 
                    hasImage === 'all' ||
                    (hasImage === 'with' && stock.thumbnail) ||
                    (hasImage === 'without' && !stock.thumbnail);

                return matchesSearch && matchesQuantity && matchesImage;
            });
            
            const filteredMovements = stocks.filter(stock => {
                 const searchTermLower = searchTerm.toLowerCase();
                const matchesSearch = searchTermLower === '' ||
                    stock.codice.toLowerCase().includes(searchTermLower) ||
                    stock.descrizione.toLowerCase().includes(searchTermLower);
                
                const matchesStartDate = startDate === '' || stock.date >= startDate;
                const matchesEndDate = endDate === '' || stock.date <= endDate;
                
                return matchesSearch && matchesStartDate && matchesEndDate;
            });
            
            const sortedMovements = [...filteredMovements].sort((a,b) => new Date(b.date).getTime() - new Date(a.date).getTime());


            const totalQuantity = Object.values(stockByCode).reduce((sum, s) => sum + s.totalQuantity, 0);
            
            const totalValue = stocks.reduce((sum, s) => {
                 return s.price !== null ? sum + (s.quantity * s.price) : sum
            },0);

            const existingCodes = [...new Set(stocks.map(s => s.codice.toUpperCase()))];
            
            const exportToExcel = () => {
                const dataToExport = filteredAndAggregatedStocks.map(s => ({
                    'Codice': s.codice,
                    'Descrizione': s.descrizione,
                    'Quantità Totale': s.totalQuantity,
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Scorte");
                XLSX.writeFile(workbook, "scorte.xlsx");
            };

            const exportToPdf = () => {
                const doc = new jspdf.jsPDF();
                doc.autoTable({
                    head: [['Codice', 'Descrizione', 'Quantità Totale']],
                    body: filteredAndAggregatedStocks.map(s => [s.codice, s.descrizione, s.totalQuantity]),
                });
                doc.save('scorte.pdf');
            };

            return (
                <>
                    <StockFilterControls
                        searchTerm={searchTerm}
                        setSearchTerm={setSearchTerm}
                        startDate={startDate}
                        setStartDate={setStartDate}
                        endDate={endDate}
                        setEndDate={setEndDate}
                        quantityFilter={quantityFilter}
                        setQuantityFilter={setQuantityFilter}
                        hasImage={hasImage}
                        setHasImage={setHasImage}
                    />
                    
                    <ExportButtons onExportExcel={exportToExcel} onExportPdf={exportToPdf} disabled={filteredAndAggregatedStocks.length === 0} />


                    {/* Totals Summary */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div className="bg-white rounded-lg shadow p-4">
                            <p className="text-sm text-slate-600">Articoli Unici</p>
                            <p className="text-2xl font-bold text-purple-600">{Object.keys(stockByCode).length}</p>
                        </div>
                        <div className="bg-white rounded-lg shadow p-4">
                            <p className="text-sm text-slate-600">Quantità Totale</p>
                            <p className="text-2xl font-bold text-slate-900">{totalQuantity}</p>
                        </div>
                        <div className="bg-white rounded-lg shadow p-4">
                            <p className="text-sm text-slate-600">Valore Totale Magazzino</p>
                            <p className="text-2xl font-bold text-slate-900">
                                {totalValue.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' })}
                            </p>
                        </div>
                    </div>

                    {undoStack.length > 0 && (
                        <div className="mb-4 bg-slate-800 text-white px-4 py-3 rounded-lg flex justify-between items-center">
                            <span className="text-sm">Elemento eliminato</span>
                            <button
                                onClick={handleUndo}
                                className="px-3 py-1 bg-white text-slate-800 rounded text-sm font-medium hover:bg-slate-100"
                            >
                                Annulla
                            </button>
                        </div>
                    )}
                    
                    <h2 className="text-xl font-semibold text-slate-800 mb-4 border-b pb-2">Movimenti Recenti</h2>

                    {sortedMovements.length > 0 ? (
                        <StockList
                            stocks={sortedMovements}
                            onEdit={handleEditStock}
                            onDelete={handleDeleteStock}
                            onDuplicate={handleDuplicateStock}
                            onImageClick={setLightboxImage}
                        />
                    ) : (
                        <div className="text-center py-16 px-4 bg-white rounded-lg shadow">
                            <h2 className="text-xl font-semibold text-slate-700">
                                {stocks.length > 0 ? 'Nessun movimento corrisponde ai filtri' : 'Nessun movimento registrato.'}
                            </h2>
                            <p className="text-slate-500 mt-2">
                                {stocks.length > 0 ? 'Prova a modificare o reimpostare i filtri di ricerca.' : "Premi il pulsante '+' in basso a destra per registrare il primo movimento."}
                            </p>
                        </div>
                    )}

                    {isFormVisible && (
                        <StockForm
                            onSave={handleSaveStock}
                            onCancel={closeForm}
                            initialStock={editingStock}
                            existingCodes={existingCodes}
                        />
                    )}

                    {lightboxImage && (
                        <ImageLightbox
                            imageUrl={lightboxImage}
                            onClose={() => setLightboxImage(null)}
                        />
                    )}

                    <button
                        onClick={openForm}
                        className="fixed bottom-8 right-8 bg-purple-600 text-white rounded-full p-4 shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition-transform duration-200 ease-in-out hover:scale-110"
                    >
                        <PlusIcon />
                    </button>
                </>
            );
        };

        // OrderForm Component
        const OrderForm = ({ onSave, onCancel, initialOrder }) => {
            const [customer, setCustomer] = useState('');
            const [article, setArticle] = useState('');
            const [quantity, setQuantity] = useState(1);
            const [salePrice, setSalePrice] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [status, setStatus] = useState(OrderStatus.DaIniziare);
            const [cloudLink, setCloudLink] = useState('');

            useEffect(() => {
                if (initialOrder) {
                    setCustomer(initialOrder.customer);
                    setArticle(initialOrder.article);
                    setQuantity(initialOrder.quantity);
                    setSalePrice(initialOrder.salePrice || '');
                    setDate(initialOrder.date);
                    setStatus(initialOrder.status);
                    setCloudLink(initialOrder.cloudLink || '');
                }
            }, [initialOrder]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!customer || !article || quantity === '' || quantity <= 0 || salePrice === '' || salePrice < 0) {
                    alert('Per favore, compila tutti i campi obbligatori. Quantità e prezzo non possono essere negativi.');
                    return;
                }

                const orderData = {
                    date,
                    customer,
                    article,
                    quantity: Number(quantity),
                    salePrice: Number(salePrice),
                    status,
                    cloudLink,
                };

                if (initialOrder) {
                    onSave({ ...orderData, id: initialOrder.id });
                } else {
                    onSave(orderData);
                }
            };

            const formTitle = initialOrder ? 'Modifica Ordine' : 'Nuovo Ordine';
            const total = (quantity !== '' && salePrice !== '' && quantity > 0 && salePrice >= 0)
                ? (Number(quantity) * Number(salePrice)).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                : '0,00';

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-full overflow-y-auto">
                        <div className="flex justify-between items-center p-5 border-b border-slate-200">
                            <h2 className="text-xl font-semibold">{formTitle}</h2>
                            <button onClick={onCancel} className="p-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100">
                                <CloseIcon />
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-5 space-y-4">
                            <div>
                                <label htmlFor="customer" className="block text-sm font-medium text-slate-700">Cliente</label>
                                <input type="text" id="customer" value={customer} onChange={e => setCustomer(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div>
                                <label htmlFor="article" className="block text-sm font-medium text-slate-700">Articolo</label>
                                <input type="text" id="article" value={article} onChange={e => setArticle(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="quantity" className="block text-sm font-medium text-slate-700">Quantità</label>
                                    <input type="number" id="quantity" value={quantity} onChange={e => setQuantity(e.target.value === '' ? '' : parseInt(e.target.value, 10))} min="1" required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                                </div>
                                <div>
                                    <label htmlFor="salePrice" className="block text-sm font-medium text-slate-700">Prezzo Vendita (€)</label>
                                    <input type="number" id="salePrice" value={salePrice} onChange={e => setSalePrice(e.target.value === '' ? '' : Number(e.target.value))} min="0" step="0.01" required placeholder="Es. 19,99" className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                                </div>
                            </div>
                            <div className="p-3 bg-slate-100 rounded-md text-right">
                                <span className="text-sm font-medium text-slate-600">Totale: </span>
                                <span className="text-xl font-bold text-slate-900">€ {total}</span>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="date" className="block text-sm font-medium text-slate-700">Data</label>
                                    <input type="date" id="date" value={date} onChange={e => setDate(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                                </div>
                                <div>
                                    <label htmlFor="status" className="block text-sm font-medium text-slate-700">Stato</label>
                                    <select id="status" value={status} onChange={e => setStatus(e.target.value)} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                        {Object.values(OrderStatus).map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label htmlFor="cloudLink" className="block text-sm font-medium text-slate-700">Link Cloud (Opzionale)</label>
                                <input type="url" id="cloudLink" value={cloudLink} onChange={e => setCloudLink(e.target.value)} placeholder="https://..." className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" />
                            </div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onCancel} className="px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                                    Annulla
                                </button>
                                <button type="submit" className="px-4 py-2 bg-blue-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    Salva Ordine
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // ExpenseForm Component
        const ExpenseForm = ({ onSave, onCancel, initialExpense }) => {
            const [description, setDescription] = useState('');
            const [quantity, setQuantity] = useState(1);
            const [price, setPrice] = useState('');
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

            useEffect(() => {
                if (initialExpense) {
                    setDescription(initialExpense.description);
                    setQuantity(initialExpense.quantity);
                    setPrice(initialExpense.price);
                    setDate(initialExpense.date);
                }
            }, [initialExpense]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!description || quantity === '' || quantity <= 0 || price === '' || price < 0) {
                    alert('Per favore, compila tutti i campi obbligatori. Quantità e prezzo non possono essere negativi.');
                    return;
                }

                const expenseData = {
                    date,
                    description,
                    quantity: Number(quantity),
                    price: Number(price),
                };

                if (initialExpense) {
                    onSave({ ...expenseData, id: initialExpense.id });
                } else {
                    onSave(expenseData);
                }
            };

            const formTitle = initialExpense ? 'Modifica Spesa' : 'Nuova Spesa';
            const total = (quantity !== '' && price !== '' && quantity > 0 && price >= 0)
                ? (Number(quantity) * Number(price)).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                : '0,00';

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-full overflow-y-auto">
                        <div className="flex justify-between items-center p-5 border-b border-slate-200">
                            <h2 className="text-xl font-semibold">{formTitle}</h2>
                            <button onClick={onCancel} className="p-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100">
                                <CloseIcon />
                            </button>
                        </div>
                        <form onSubmit={handleSubmit} className="p-5 space-y-4">
                            <div>
                                <label htmlFor="description" className="block text-sm font-medium text-slate-700">Descrizione</label>
                                <textarea id="description" value={description} onChange={e => setDescription(e.target.value)} required rows={3} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label htmlFor="quantity" className="block text-sm font-medium text-slate-700">Quantità</label>
                                    <input type="number" id="quantity" value={quantity} onChange={e => setQuantity(e.target.value === '' ? '' : parseInt(e.target.value, 10))} min="1" required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" />
                                </div>
                                <div>
                                    <label htmlFor="price" className="block text-sm font-medium text-slate-700">Prezzo (€)</label>
                                    <input type="number" id="price" value={price} onChange={e => setPrice(e.target.value === '' ? '' : Number(e.target.value))} min="0" step="0.01" required placeholder="Es. 19,99" className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" />
                                </div>
                            </div>
                            <div className="p-3 bg-slate-100 rounded-md text-right">
                                <span className="text-sm font-medium text-slate-600">Totale: </span>
                                <span className="text-xl font-bold text-slate-900">€ {total}</span>
                            </div>
                            <div>
                                <label htmlFor="date" className="block text-sm font-medium text-slate-700">Data</label>
                                <input type="date" id="date" value={date} onChange={e => setDate(e.target.value)} required className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500 sm:text-sm" />
                            </div>
                            <div className="flex justify-end space-x-3 pt-4">
                                <button type="button" onClick={onCancel} className="px-4 py-2 bg-white border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                                    Annulla
                                </button>
                                <button type="submit" className="px-4 py-2 bg-emerald-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                                    Salva Spesa
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // OrderItem Component
        const OrderItem = ({ order, onEdit, onDelete }) => {
            const statusColors = {
                [OrderStatus.DaIniziare]: 'bg-slate-100 text-slate-800',
                [OrderStatus.InSvolgimento]: 'bg-yellow-100 text-yellow-800',
                [OrderStatus.Terminato]: 'bg-green-100 text-green-800',
            };

            const formattedDate = new Date(order.date).toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
            });

            const formatCurrency = (value) => {
                if (typeof value !== 'number') return 'N/D';
                return value.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
            };

            const total = order.quantity * (order.salePrice || 0);

            return (
                <div className="bg-white rounded-lg shadow-md overflow-hidden transition-shadow duration-300 hover:shadow-xl">
                    <div className="p-5">
                        <div className="flex justify-between items-start">
                            <div>
                                <h3 className="text-xl font-bold text-slate-800">{order.customer}</h3>
                                <p className="text-sm text-slate-500">{formattedDate}</p>
                            </div>
                            <span className={`px-3 py-1 text-sm font-semibold rounded-full ${statusColors[order.status]}`}>
                                {order.status}
                            </span>
                        </div>
                        <div className="mt-4 border-t border-slate-200 pt-4">
                            <p className="text-slate-700">
                                <span className="font-semibold">Articolo:</span> {order.article}
                            </p>
                            <div className="grid grid-cols-3 gap-4 mt-2 text-center md:text-left">
                                <div>
                                    <p className="text-sm text-slate-500">Quantità</p>
                                    <p className="font-semibold text-slate-800">{order.quantity}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-slate-500">Prezzo Unitario</p>
                                    <p className="font-semibold text-slate-800">{formatCurrency(order.salePrice)}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-slate-500">Totale</p>
                                    <p className="font-bold text-slate-900 text-lg">{formatCurrency(total)}</p>
                                </div>
                            </div>
                            {order.cloudLink && (
                                <div className="mt-3 flex items-center space-x-2 border-t border-slate-100 pt-3">
                                    <LinkIcon />
                                    <a href={order.cloudLink} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 hover:underline truncate">
                                        {order.cloudLink}
                                    </a>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="bg-slate-50 px-5 py-3 flex justify-end space-x-3">
                        <button onClick={() => onEdit(order)} className="p-2 text-slate-500 hover:text-slate-700 hover:bg-slate-200 rounded-full transition-colors duration-200">
                            <EditIcon />
                        </button>
                        <button onClick={() => onDelete(order.id)} className="p-2 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-full transition-colors duration-200">
                            <TrashIcon />
                        </button>
                    </div>
                </div>
            );
        };

        // ExpenseItem Component
        const ExpenseItem = ({ expense, onEdit, onDelete }) => {
            const formattedDate = new Date(expense.date).toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
            });

            const formatCurrency = (value) => {
                return value.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
            };

            const total = expense.quantity * expense.price;

            return (
                <div className="bg-white rounded-lg shadow-md overflow-hidden transition-shadow duration-300 hover:shadow-xl">
                    <div className="p-5">
                        <div className="flex justify-between items-start">
                            <h3 className="text-lg font-bold text-slate-800 flex-1 pr-4">{expense.description}</h3>
                            <p className="text-sm text-slate-500 whitespace-nowrap">{formattedDate}</p>
                        </div>
                        <div className="mt-4 border-t border-slate-200 pt-4">
                            <div className="grid grid-cols-3 gap-4 text-center md:text-left">
                                <div>
                                    <p className="text-sm text-slate-500">Quantità</p>
                                    <p className="font-semibold text-slate-800">{expense.quantity}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-slate-500">Prezzo Unitario</p>
                                    <p className="font-semibold text-slate-800">{formatCurrency(expense.price)}</p>
                                </div>
                                <div>
                                    <p className="text-sm text-slate-500">Totale</p>
                                    <p className="font-bold text-slate-900 text-lg">{formatCurrency(total)}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="bg-slate-50 px-5 py-3 flex justify-end space-x-3">
                        <button onClick={() => onEdit(expense)} className="p-2 text-slate-500 hover:text-slate-700 hover:bg-slate-200 rounded-full transition-colors duration-200">
                            <EditIcon />
                        </button>
                        <button onClick={() => onDelete(expense.id)} className="p-2 text-red-500 hover:text-red-700 hover:bg-red-100 rounded-full transition-colors duration-200">
                            <TrashIcon />
                        </button>
                    </div>
                </div>
            );
        };

        // OrderList Component
        const OrderList = ({ orders, onEdit, onDelete }) => {
            return (
                <div className="space-y-4">
                    {orders.map(order => (
                        <OrderItem key={order.id} order={order} onEdit={onEdit} onDelete={onDelete} />
                    ))}
                </div>
            );
        };

        // ExpenseList Component
        const ExpenseList = ({ expenses, onEdit, onDelete }) => {
            return (
                <div className="space-y-4">
                    {expenses.map(expense => (
                        <ExpenseItem key={expense.id} expense={expense} onEdit={onEdit} onDelete={onDelete} />
                    ))}
                </div>
            );
        };

        // OrdersView Component
        const OrdersView = ({ orders, setOrders }) => {
            const [isFormVisible, setIsFormVisible] = useState(false);
            const [editingOrder, setEditingOrder] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');

            const handleSaveOrder = (orderToSave) => {
                if ('id' in orderToSave) {
                    setOrders(orders.map(o => o.id === orderToSave.id ? orderToSave : o));
                } else {
                    const newOrder = {
                        ...orderToSave,
                        id: new Date().toISOString() + Math.random(),
                    };
                    setOrders([...orders, newOrder]);
                }
                closeForm();
            };

            const handleDeleteOrder = (id) => {
                if (window.confirm("Sei sicuro di voler eliminare questo ordine?")) {
                    setOrders(orders.filter(o => o.id !== id));
                }
            };

            const handleEditOrder = (order) => {
                setEditingOrder(order);
                setIsFormVisible(true);
            };

            const openForm = () => {
                setEditingOrder(null);
                setIsFormVisible(true);
            };

            const closeForm = () => {
                setIsFormVisible(false);
                setEditingOrder(null);
            };

            const filteredOrders = orders.filter(order => {
                const searchTermLower = searchTerm.toLowerCase();
                const matchesSearch = searchTermLower === '' ||
                    order.customer.toLowerCase().includes(searchTermLower) ||
                    order.article.toLowerCase().includes(searchTermLower);

                const matchesStatus = statusFilter === 'all' || order.status === statusFilter;
                const matchesStartDate = startDate === '' || order.date >= startDate;
                const matchesEndDate = endDate === '' || order.date <= endDate;

                return matchesSearch && matchesStatus && matchesStartDate && matchesEndDate;
            });

            const sortedAndFilteredOrders = [...filteredOrders].sort((a, b) => 
                new Date(b.date).getTime() - new Date(a.date).getTime()
            );
            
            const exportToExcel = () => {
                const dataToExport = sortedAndFilteredOrders.map(o => ({
                    'Data': new Date(o.date).toLocaleDateString('it-IT'),
                    'Cliente': o.customer,
                    'Articolo': o.article,
                    'Quantità': o.quantity,
                    'Prezzo Vendita': o.salePrice,
                    'Totale': o.quantity * o.salePrice,
                    'Stato': o.status,
                    'Link': o.cloudLink
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Ordini");
                XLSX.writeFile(workbook, "ordini.xlsx");
            };

            const exportToPdf = () => {
                const doc = new jspdf.jsPDF();
                doc.autoTable({
                    head: [['Data', 'Cliente', 'Articolo', 'Qtà', 'Prezzo', 'Totale', 'Stato']],
                    body: sortedAndFilteredOrders.map(o => [
                        new Date(o.date).toLocaleDateString('it-IT'),
                        o.customer,
                        o.article,
                        o.quantity,
                        o.salePrice.toLocaleString('it-IT', {style:'currency', currency:'EUR'}),
                        (o.quantity * o.salePrice).toLocaleString('it-IT', {style:'currency', currency:'EUR'}),
                        o.status
                    ]),
                });
                doc.save('ordini.pdf');
            };

            return (
                <>
                    <FilterControls
                        searchTerm={searchTerm}
                        setSearchTerm={setSearchTerm}
                        statusFilter={statusFilter}
                        setStatusFilter={setStatusFilter}
                        startDate={startDate}
                        setStartDate={setStartDate}
                        endDate={endDate}
                        setEndDate={setEndDate}
                    />

                    <ExportButtons onExportExcel={exportToExcel} onExportPdf={exportToPdf} disabled={sortedAndFilteredOrders.length === 0} />


                    {sortedAndFilteredOrders.length > 0 ? (
                        <OrderList
                            orders={sortedAndFilteredOrders}
                            onEdit={handleEditOrder}
                            onDelete={handleDeleteOrder}
                        />
                    ) : (
                        <div className="text-center py-16 px-4 bg-white rounded-lg shadow">
                            <h2 className="text-xl font-semibold text-slate-700">
                                {orders.length > 0 ? 'Nessun ordine corrisponde ai filtri' : 'Nessun ordine trovato.'}
                            </h2>
                            <p className="text-slate-500 mt-2">
                                {orders.length > 0 ? 'Prova a modificare o reimpostare i filtri di ricerca.' : "Premi il pulsante '+' in basso a destra per creare un nuovo ordine."}
                            </p>
                        </div>
                    )}

                    {isFormVisible && (
                        <OrderForm
                            onSave={handleSaveOrder}
                            onCancel={closeForm}
                            initialOrder={editingOrder}
                        />
                    )}

                    <button
                        onClick={openForm}
                        className="fixed bottom-8 right-8 bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform duration-200 ease-in-out hover:scale-110"
                    >
                        <PlusIcon />
                    </button>
                </>
            );
        };

        // ExpensesView Component
        const ExpensesView = ({ expenses, setExpenses }) => {
            const [isFormVisible, setIsFormVisible] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');

            const handleSaveExpense = (expenseToSave) => {
                if ('id' in expenseToSave) {
                    setExpenses(expenses.map(e => e.id === expenseToSave.id ? expenseToSave : e));
                } else {
                    const newExpense = {
                        ...expenseToSave,
                        id: new Date().toISOString() + Math.random(),
                    };
                    setExpenses([...expenses, newExpense]);
                }
                closeForm();
            };

            const handleDeleteExpense = (id) => {
                if (window.confirm("Sei sicuro di voler eliminare questa spesa?")) {
                    setExpenses(expenses.filter(e => e.id !== id));
                }
            };

            const handleEditExpense = (expense) => {
                setEditingExpense(expense);
                setIsFormVisible(true);
            };

            const openForm = () => {
                setEditingExpense(null);
                setIsFormVisible(true);
            };

            const closeForm = () => {
                setIsFormVisible(false);
                setEditingExpense(null);
            };

            const filteredExpenses = expenses.filter(expense => {
                const searchTermLower = searchTerm.toLowerCase();
                const matchesSearch = searchTermLower === '' ||
                    expense.description.toLowerCase().includes(searchTermLower);

                const matchesStartDate = startDate === '' || expense.date >= startDate;
                const matchesEndDate = endDate === '' || expense.date <= endDate;

                return matchesSearch && matchesStartDate && matchesEndDate;
            });

            const sortedAndFilteredExpenses = [...filteredExpenses].sort((a, b) => 
                new Date(b.date).getTime() - new Date(a.date).getTime()
            );
            
            const exportToExcel = () => {
                const dataToExport = sortedAndFilteredExpenses.map(e => ({
                    'Data': new Date(e.date).toLocaleDateString('it-IT'),
                    'Descrizione': e.description,
                    'Quantità': e.quantity,
                    'Prezzo': e.price,
                    'Totale': e.quantity * e.price,
                }));
                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Spese");
                XLSX.writeFile(workbook, "spese.xlsx");
            };

            const exportToPdf = () => {
                const doc = new jspdf.jsPDF();
                doc.autoTable({
                    head: [['Data', 'Descrizione', 'Qtà', 'Prezzo', 'Totale']],
                    body: sortedAndFilteredExpenses.map(e => [
                        new Date(e.date).toLocaleDateString('it-IT'),
                        e.description,
                        e.quantity,
                        e.price.toLocaleString('it-IT', {style:'currency', currency:'EUR'}),
                        (e.quantity * e.price).toLocaleString('it-IT', {style:'currency', currency:'EUR'}),
                    ]),
                });
                doc.save('spese.pdf');
            };

            return (
                <>
                    <ExpenseFilterControls
                        searchTerm={searchTerm}
                        setSearchTerm={setSearchTerm}
                        startDate={startDate}
                        setStartDate={setStartDate}
                        endDate={endDate}
                        setEndDate={setEndDate}
                    />

                    <ExportButtons onExportExcel={exportToExcel} onExportPdf={exportToPdf} disabled={sortedAndFilteredExpenses.length === 0} />


                    {sortedAndFilteredExpenses.length > 0 ? (
                        <ExpenseList
                            expenses={sortedAndFilteredExpenses}
                            onEdit={handleEditExpense}
                            onDelete={handleDeleteExpense}
                        />
                    ) : (
                        <div className="text-center py-16 px-4 bg-white rounded-lg shadow">
                            <h2 className="text-xl font-semibold text-slate-700">
                                {expenses.length > 0 ? 'Nessuna spesa corrisponde ai filtri' : 'Nessuna spesa trovata.'}
                            </h2>
                            <p className="text-slate-500 mt-2">
                                {expenses.length > 0 ? 'Prova a modificare o reimpostare i filtri di ricerca.' : "Premi il pulsante '+' in basso a destra per creare una nuova spesa."}
                            </p>
                        </div>
                    )}

                    {isFormVisible && (
                        <ExpenseForm
                            onSave={handleSaveExpense}
                            onCancel={closeForm}
                            initialExpense={editingExpense}
                        />
                    )}

                    <button
                        onClick={openForm}
                        className="fixed bottom-8 right-8 bg-emerald-600 text-white rounded-full p-4 shadow-lg hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition-transform duration-200 ease-in-out hover:scale-110"
                    >
                        <PlusIcon />
                    </button>
                </>
            );
        };

        // Main App Component
        const App = () => {
            const [activeTab, setActiveTab] = useState('orders');
            const [orders, setOrders] = useLocalStorage('ordersV2', []);
            const [expenses, setExpenses] = useLocalStorage('expensesV2', []);
            const [stocks, setStocks] = useLocalStorage('stocksV2', []);
            
            const handleExportData = () => {
                const allData = {
                    orders,
                    expenses,
                    stocks,
                    exportDate: new Date().toISOString(),
                };
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'gestione_backup.json';
                a.click();
                URL.revokeObjectURL(url);
            };

            const handleImportData = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm("Sei sicuro di voler importare i dati? I dati attuali verranno sovrascritti.")) {
                            setOrders(data.orders || []);
                            setExpenses(data.expenses || []);
                            setStocks(data.stocks || []);
                            alert("Dati importati con successo!");
                        }
                    } catch (error) {
                        alert("Errore nell'importazione del file. Assicurati che sia un file di backup valido.");
                        console.error("Import error:", error);
                    }
                };
                reader.readAsText(file);
                // Reset input value to allow re-uploading the same file
                event.target.value = null; 
            };


            const tabClasses = (tabName) =>
                `px-4 py-2 text-sm font-medium rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 transition ${
                    activeTab === tabName
                        ? tabName === 'orders' ? 'bg-blue-600 text-white shadow focus:ring-blue-500' : 
                          tabName === 'expenses' ? 'bg-emerald-600 text-white shadow focus:ring-emerald-500' :
                          'bg-purple-600 text-white shadow focus:ring-purple-500'
                        : 'text-slate-600 hover:bg-slate-200'
                }`;

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-800">
                    <header className="bg-white shadow-md sticky top-0 z-40">
                        <div className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                            <h1 className="text-2xl font-bold text-slate-900 tracking-tight">Gestione Attività</h1>
                            <div className="flex items-center gap-2">
                                <button
                                  onClick={handleExportData}
                                  className="px-3 py-1.5 text-xs font-medium text-slate-700 bg-slate-100 border border-slate-300 rounded-md hover:bg-slate-200"
                                >
                                  Esporta Dati
                                </button>
                                <label className="px-3 py-1.5 text-xs font-medium text-slate-700 bg-slate-100 border border-slate-300 rounded-md hover:bg-slate-200 cursor-pointer">
                                  Importa Dati
                                  <input type="file" accept=".json" onChange={handleImportData} className="hidden" />
                                </label>
                            </div>
                        </div>
                        <nav className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pb-3">
                            <div className="bg-slate-100 p-1 rounded-lg flex space-x-1 overflow-x-auto">
                                <button onClick={() => setActiveTab('orders')} className={tabClasses('orders')}>
                                    Ordini
                                </button>
                                <button onClick={() => setActiveTab('expenses')} className={tabClasses('expenses')}>
                                    Spese
                                </button>
                                <button onClick={() => setActiveTab('stocks')} className={tabClasses('stocks')}>
                                    Scorte
                                </button>
                            </div>
                        </nav>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-24">
                        {activeTab === 'orders' && <OrdersView orders={orders} setOrders={setOrders} />}
                        {activeTab === 'expenses' && <ExpensesView expenses={expenses} setExpenses={setExpenses} />}
                        {activeTab === 'stocks' && <StocksView stocks={stocks} setStocks={setStocks} />}
                    </main>
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>