<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Gestione Attività</title>
    
    <!-- PWA Meta Tags -->
    <meta name="application-name" content="Gestione Attività">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Gestione">
    <meta name="theme-color" content="#f1f5f9">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior-y: none;
            -webkit-user-select: none;
            user-select: none;
        }
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
        * {
            -webkit-tap-highlight-color: transparent;
        }
        .compact-input {
            padding: 0.35rem 0.6rem !important;
            font-size: 0.875rem !important;
            min-height: 36px !important;
        }
        .compact-select {
            padding: 0.35rem 0.6rem !important;
            font-size: 0.875rem !important;
            min-height: 36px !important;
        }
        .thumbnail-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.375rem;
            cursor: pointer;
        }
        .compact-card {
            padding: 0.875rem !important;
        }
        @media (max-width: 768px) {
            .compact-input, .compact-select {
                min-height: 40px !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, StrictMode } = React;

        // =================================================================
        // GITHUB CONFIGURATION
        // =================================================================
        const GITHUB_CONFIG = {
            owner: '',
            repo: '',
            branch: 'main',
            dataFile: 'data.json',
            token: ''
        };

        // =================================================================
        // GITHUB API FUNCTIONS
        // =================================================================
        const GitHubAPI = {
            async getFile() {
                if (!GITHUB_CONFIG.token || !GITHUB_CONFIG.owner || !GITHUB_CONFIG.repo) {
                    return null;
                }
                
                try {
                    const response = await fetch(
                        `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}?ref=${GITHUB_CONFIG.branch}`,
                        {
                            headers: {
                                'Authorization': `token ${GITHUB_CONFIG.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (response.status === 404) return null;
                    if (!response.ok) throw new Error('Errore nel recupero dati');
                    
                    const data = await response.json();
                    const content = atob(data.content);
                    return { data: JSON.parse(content), sha: data.sha };
                } catch (error) {
                    console.error('Errore GitHub API:', error);
                    return null;
                }
            },

            async saveFile(content, sha = null) {
                if (!GITHUB_CONFIG.token || !GITHUB_CONFIG.owner || !GITHUB_CONFIG.repo) {
                    return false;
                }
                
                try {
                    const encodedContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));
                    
                    const body = {
                        message: `Aggiornamento dati - ${new Date().toISOString()}`,
                        content: encodedContent,
                        branch: GITHUB_CONFIG.branch
                    };
                    
                    if (sha) body.sha = sha;
                    
                    const response = await fetch(
                        `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${GITHUB_CONFIG.token}`,
                                'Accept': 'application/vnd.github.v3+json',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(body)
                        }
                    );
                    
                    if (!response.ok) throw new Error('Errore nel salvataggio');
                    return true;
                } catch (error) {
                    console.error('Errore nel salvataggio su GitHub:', error);
                    return false;
                }
            }
        };

        // =================================================================
        // TYPES
        // =================================================================
        const OrderStatus = {
            DaIniziare: 'Da Iniziare',
            InSvolgimento: 'In Svolgimento',
            Terminato: 'Terminato',
        };

        // =================================================================
        // HOOKS WITH GITHUB SYNC
        // =================================================================
        function useGitHubStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(initialValue);
            const [sha, setSha] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [isSyncing, setIsSyncing] = useState(false);

            useEffect(() => {
                loadFromGitHub();
            }, []);

            const loadFromGitHub = async () => {
                setIsLoading(true);
                const result = await GitHubAPI.getFile();
                
                if (result) {
                    setStoredValue(result.data[key] || initialValue);
                    setSha(result.sha);
                } else {
                    try {
                        const item = window.localStorage.getItem(key);
                        setStoredValue(item ? JSON.parse(item) : initialValue);
                    } catch (error) {
                        console.error(error);
                        setStoredValue(initialValue);
                    }
                }
                setIsLoading(false);
            };

            const setValue = async (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    
                    if (typeof window !== 'undefined') {
                        window.localStorage.setItem(key, JSON.stringify(valueToStore));
                    }

                    setIsSyncing(true);
                    const currentData = await GitHubAPI.getFile();
                    const newData = currentData ? { ...currentData.data } : {};
                    newData[key] = valueToStore;
                    
                    const success = await GitHubAPI.saveFile(newData, currentData?.sha);
                    if (success && currentData) {
                        setSha(currentData.sha);
                    }
                    setIsSyncing(false);
                } catch (error) {
                    console.error(error);
                    setIsSyncing(false);
                }
            };

            return [storedValue, setValue, { isLoading, isSyncing }];
        }

        // =================================================================
        // UTILS
        // =================================================================
        const resizeImage = (file, maxWidth, maxHeight) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width *= maxHeight / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const formatCurrency = (value) => {
            if (value === null || value === undefined) return '—';
            return value.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
        };

        const formatDate = (dateString) => {
            return new Date(dateString).toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'short',
                year: 'numeric',
            });
        };

        // =================================================================
        // ICONS
        // =================================================================
        const PlusIcon = () => (
            <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
            </svg>
        );
        const EditIcon = () => (
            <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z" />
            </svg>
        );
        const TrashIcon = () => (
            <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );
        const SaveIcon = () => (
            <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
            </svg>
        );
        const CloseIcon = () => (
            <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        );
        const SyncIcon = ({className = "h-4 w-4"}) => (
            <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );
        const CameraIcon = () => (
            <svg className="h-8 w-8 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={1.5}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );

        // =================================================================
        // IMAGE LIGHTBOX
        // =================================================================
        const ImageLightbox = ({ imageUrl, onClose }) => {
            useEffect(() => {
                const handleEscape = (e) => {
                    if (e.key === 'Escape') onClose();
                };
                document.addEventListener('keydown', handleEscape);
                return () => document.removeEventListener('keydown', handleEscape);
            }, [onClose]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[100] p-4" onClick={onClose}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-white hover:text-slate-300 p-2 bg-black bg-opacity-30 rounded-full z-10">
                        <CloseIcon />
                    </button>
                    <img src={imageUrl} alt="Ingrandimento" className="max-w-full max-h-full object-contain rounded-lg shadow-2xl" onClick={(e) => e.stopPropagation()} />
                </div>
            );
        };

        // =================================================================
        // MODAL
        // =================================================================
        const Modal = ({ title, onClose, children, maxWidth = "max-w-3xl" }) => {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className={`bg-white rounded-lg shadow-2xl w-full ${maxWidth} max-h-[90vh] flex flex-col`}>
                        <div className="flex justify-between items-center p-4 border-b border-slate-200">
                            <h2 className="text-lg font-semibold text-slate-800">{title}</h2>
                            <button onClick={onClose} className="p-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100">
                                <CloseIcon />
                            </button>
                        </div>
                        <div className="overflow-y-auto p-4">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================
        // COMPACT ORDER FORM
        // =================================================================
        const CompactOrderForm = ({ onSave, initialOrder }) => {
            const [customer, setCustomer] = useState(initialOrder?.customer || '');
            const [article, setArticle] = useState(initialOrder?.article || '');
            const [quantity, setQuantity] = useState(initialOrder?.quantity || 1);
            const [salePrice, setSalePrice] = useState(initialOrder?.salePrice?.toString() || '');
            const [date, setDate] = useState(initialOrder?.date || new Date().toISOString().split('T')[0]);
            const [status, setStatus] = useState(initialOrder?.status || OrderStatus.DaIniziare);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!customer || !article || quantity <= 0 || salePrice === '' || Number(salePrice) < 0) {
                    alert('Compila tutti i campi obbligatori');
                    return;
                }
                onSave({
                    id: initialOrder?.id || new Date().toISOString() + Math.random(),
                    date,
                    customer,
                    article,
                    status,
                    quantity: Number(quantity),
                    salePrice: Number(salePrice),
                    cloudLink: initialOrder?.cloudLink || ''
                });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-3">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Cliente *</label>
                            <input type="text" value={customer} onChange={e => setCustomer(e.target.value)} required className="compact-input block w-full rounded border-slate-300 border focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Articolo *</label>
                            <input type="text" value={article} onChange={e => setArticle(e.target.value)} required className="compact-input block w-full rounded border-slate-300 border focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                        </div>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Quantità *</label>
                            <input type="number" value={quantity} onChange={e => setQuantity(parseInt(e.target.value) || 0)} min="1" required className="compact-input block w-full rounded border-slate-300 border focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Prezzo € *</label>
                            <input type="number" value={salePrice} onChange={e => setSalePrice(e.target.value)} min="0" step="0.01" required className="compact-input block w-full rounded border-slate-300 border focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Data *</label>
                            <input type="date" value={date} onChange={e => setDate(e.target.value)} required className="compact-input block w-full rounded border-slate-300 border focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Stato *</label>
                            <select value={status} onChange={e => setStatus(e.target.value)} className="compact-select block w-full rounded border-slate-300 border focus:border-blue-500 focus:ring-1 focus:ring-blue-500">
                                {Object.values(OrderStatus).map(s => <option key={s} value={s}>{s}</option>)}
                            </select>
                        </div>
                    </div>
                    <div className="bg-slate-50 p-3 rounded">
                        <span className="text-sm font-medium text-slate-600">Totale: </span>
                        <span className="text-lg font-bold text-slate-900">
                            {quantity > 0 && salePrice ? formatCurrency(quantity * Number(salePrice)) : '€ 0,00'}
                        </span>
                    </div>
                    <div className="flex justify-end gap-2 pt-2">
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 flex items-center gap-2">
                            <SaveIcon /> {initialOrder ? 'Aggiorna' : 'Salva'} Ordine
                        </button>
                    </div>
                </form>
            );
        };

        // =================================================================
        // COMPACT ORDER ITEM
        // =================================================================
        const CompactOrderItem = ({ order, onEdit, onDelete }) => {
            const statusColors = { 
                [OrderStatus.DaIniziare]: 'bg-slate-100 text-slate-700', 
                [OrderStatus.InSvolgimento]: 'bg-yellow-100 text-yellow-700', 
                [OrderStatus.Terminato]: 'bg-green-100 text-green-700' 
            };
            const total = order.quantity * order.salePrice;
            
            return (
                <div className="bg-white rounded shadow-sm compact-card hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between gap-3">
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-2 mb-1 flex-wrap">
                                <h3 className="text-sm font-bold text-slate-800">{order.customer}</h3>
                                <span className={`px-2 py-0.5 text-xs font-semibold rounded ${statusColors[order.status]}`}>{order.status}</span>
                            </div>
                            <p className="text-xs text-slate-600 mb-1">{order.article}</p>
                            <div className="flex gap-3 text-xs text-slate-500 flex-wrap">
                                <span>{formatDate(order.date)}</span>
                                <span>Qtà: {order.quantity}</span>
                                <span>Prezzo: {formatCurrency(order.salePrice)}</span>
                                <span className="font-semibold text-slate-900">{formatCurrency(total)}</span>
                            </div>
                        </div>
                        <div className="flex gap-1 flex-shrink-0">
                            <button onClick={() => onEdit(order)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-full transition-colors" title="Modifica">
                                <EditIcon />
                            </button>
                            <button onClick={() => onDelete(order.id)} className="p-2 text-red-600 hover:bg-red-50 rounded-full transition-colors" title="Elimina">
                                <TrashIcon />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================
        // ORDERS VIEW
        // =================================================================
        const OrdersView = () => {
            const [orders, setOrders, { isLoading, isSyncing }] = useGitHubStorage('orders', []);
            const [showForm, setShowForm] = useState(false);
            const [editingOrder, setEditingOrder] = useState(null);

            const handleSaveOrder = (orderData) => {
                if (editingOrder) {
                    setOrders(orders.map(o => o.id === orderData.id ? orderData : o));
                } else {
                    setOrders([...orders, orderData]);
                }
                setShowForm(false);
                setEditingOrder(null);
            };

            const handleEdit = (order) => {
                setEditingOrder(order);
                setShowForm(true);
            };

            const handleDeleteOrder = (id) => {
                if (window.confirm("Eliminare questo ordine?")) {
                    setOrders(orders.filter(o => o.id !== id));
                }
            };

            const handleCancel = () => {
                setShowForm(false);
                setEditingOrder(null);
            };

            const sortedOrders = [...orders].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

            if (isLoading) {
                return <div className="text-center py-8 text-slate-600">Caricamento dati...</div>;
            }

            return (
                <div>
                    {isSyncing && (
                        <div className="mb-3 bg-blue-50 text-blue-700 px-3 py-2 rounded text-xs flex items-center gap-2">
                            <SyncIcon className="h-3 w-3 animate-spin" />
                            Sincronizzazione con GitHub...
                        </div>
                    )}
                    
                    <button onClick={() => { setEditingOrder(null); setShowForm(true); }} className="mb-3 w-full bg-blue-600 text-white rounded-lg py-3 hover:bg-blue-700 flex items-center justify-center gap-2 font-medium shadow-sm transition-colors">
                        <PlusIcon /> Nuovo Ordine
                    </button>

                    {sortedOrders.length > 0 ? (
                        <div className="space-y-2">
                            {sortedOrders.map(order => (
                                <CompactOrderItem key={order.id} order={order} onEdit={handleEdit} onDelete={handleDeleteOrder} />
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-16 bg-white rounded-lg shadow-sm">
                            <p className="text-slate-500">Nessun ordine presente</p>
                            <p className="text-slate-400 text-sm mt-1">Clicca "Nuovo Ordine" per iniziare</p>
                        </div>
                    )}

                    {showForm && (
                        <Modal title={editingOrder ? "Modifica Ordine" : "Nuovo Ordine"} onClose={handleCancel}>
                            <CompactOrderForm onSave={handleSaveOrder} initialOrder={editingOrder} />
                        </Modal>
                    )}
                </div>
            );
        };

        // =================================================================
        // COMPACT EXPENSE FORM
        // =================================================================
        const CompactExpenseForm = ({ onSave, initialExpense }) => {
            const [description, setDescription] = useState(initialExpense?.description || '');
            const [quantity, setQuantity] = useState(initialExpense?.quantity || 1);
            const [price, setPrice] = useState(initialExpense?.price?.toString() || '');
            const [date, setDate] = useState(initialExpense?.date || new Date().toISOString().split('T')[0]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!description || quantity <= 0 || price === '' || Number(price) < 0) {
                    alert('Compila tutti i campi obbligatori');
                    return;
                }
                onSave({
                    id: initialExpense?.id || new Date().toISOString() + Math.random(),
                    date,
                    description,
                    quantity: Number(quantity),
                    price: Number(price)
                });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-3">
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Descrizione *</label>
                        <input type="text" value={description} onChange={e => setDescription(e.target.value)} required className="compact-input block w-full rounded border-slate-300 border focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" />
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Quantità *</label>
                            <input type="number" value={quantity} onChange={e => setQuantity(parseInt(e.target.value) || 0)} min="1" required className="compact-input block w-full rounded border-slate-300 border focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Prezzo € *</label>
                            <input type="number" value={price} onChange={e => setPrice(e.target.value)} min="0" step="0.01" required className="compact-input block w-full rounded border-slate-300 border focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Data *</label>
                            <input type="date" value={date} onChange={e => setDate(e.target.value)} required className="compact-input block w-full rounded border-slate-300 border focus:border-emerald-500 focus:ring-1 focus:ring-emerald-500" />
                        </div>
                    </div>
                    <div className="bg-slate-50 p-3 rounded">
                        <span className="text-sm font-medium text-slate-600">Totale: </span>
                        <span className="text-lg font-bold text-slate-900">
                            {quantity > 0 && price ? formatCurrency(quantity * Number(price)) : '€ 0,00'}
                        </span>
                    </div>
                    <div className="flex justify-end gap-2 pt-2">
                        <button type="submit" className="px-4 py-2 bg-emerald-600 text-white rounded hover:bg-emerald-700 flex items-center gap-2">
                            <SaveIcon /> {initialExpense ? 'Aggiorna' : 'Salva'} Spesa
                        </button>
                    </div>
                </form>
            );
        };

        // =================================================================
        // COMPACT EXPENSE ITEM
        // =================================================================
        const CompactExpenseItem = ({ expense, onEdit, onDelete }) => {
            const total = expense.quantity * expense.price;
            
            return (
                <div className="bg-white rounded shadow-sm compact-card hover:shadow-md transition-shadow">
                    <div className="flex items-center justify-between gap-3">
                        <div className="flex-1 min-w-0">
                            <h3 className="text-sm font-bold text-slate-800 mb-1">{expense.description}</h3>
                            <div className="flex gap-3 text-xs text-slate-500 flex-wrap">
                                <span>{formatDate(expense.date)}</span>
                                <span>Qtà: {expense.quantity}</span>
                                <span>€ {expense.price.toFixed(2)}</span>
                                <span className="font-semibold text-slate-900">{formatCurrency(total)}</span>
                            </div>
                        </div>
                        <div className="flex gap-1 flex-shrink-0">
                            <button onClick={() => onEdit(expense)} className="p-2 text-emerald-600 hover:bg-emerald-50 rounded-full transition-colors" title="Modifica">
                                <EditIcon />
                            </button>
                            <button onClick={() => onDelete(expense.id)} className="p-2 text-red-600 hover:bg-red-50 rounded-full transition-colors" title="Elimina">
                                <TrashIcon />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================
        // EXPENSES VIEW
        // =================================================================
        const ExpensesView = () => {
            const [expenses, setExpenses, { isLoading, isSyncing }] = useGitHubStorage('expenses', []);
            const [showForm, setShowForm] = useState(false);
            const [editingExpense, setEditingExpense] = useState(null);

            const handleSaveExpense = (expenseData) => {
                if (editingExpense) {
                    setExpenses(expenses.map(e => e.id === expenseData.id ? expenseData : e));
                } else {
                    setExpenses([...expenses, expenseData]);
                }
                setShowForm(false);
                setEditingExpense(null);
            };

            const handleEdit = (expense) => {
                setEditingExpense(expense);
                setShowForm(true);
            };

            const handleDeleteExpense = (id) => {
                if (window.confirm("Eliminare questa spesa?")) {
                    setExpenses(expenses.filter(e => e.id !== id));
                }
            };

            const handleCancel = () => {
                setShowForm(false);
                setEditingExpense(null);
            };

            const sortedExpenses = [...expenses].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

            if (isLoading) {
                return <div className="text-center py-8 text-slate-600">Caricamento dati...</div>;
            }

            return (
                <div>
                    {isSyncing && (
                        <div className="mb-3 bg-emerald-50 text-emerald-700 px-3 py-2 rounded text-xs flex items-center gap-2">
                            <SyncIcon className="h-3 w-3 animate-spin" />
                            Sincronizzazione con GitHub...
                        </div>
                    )}
                    
                    <button onClick={() => { setEditingExpense(null); setShowForm(true); }} className="mb-3 w-full bg-emerald-600 text-white rounded-lg py-3 hover:bg-emerald-700 flex items-center justify-center gap-2 font-medium shadow-sm transition-colors">
                        <PlusIcon /> Nuova Spesa
                    </button>

                    {sortedExpenses.length > 0 ? (
                        <div className="space-y-2">
                            {sortedExpenses.map(expense => (
                                <CompactExpenseItem key={expense.id} expense={expense} onEdit={handleEdit} onDelete={handleDeleteExpense} />
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-16 bg-white rounded-lg shadow-sm">
                            <p className="text-slate-500">Nessuna spesa presente</p>
                            <p className="text-slate-400 text-sm mt-1">Clicca "Nuova Spesa" per iniziare</p>
                        </div>
                    )}

                    {showForm && (
                        <Modal title={editingExpense ? "Modifica Spesa" : "Nuova Spesa"} onClose={handleCancel}>
                            <CompactExpenseForm onSave={handleSaveExpense} initialExpense={editingExpense} />
                        </Modal>
                    )}
                </div>
            );
        };

        // =================================================================
        // COMPACT STOCK FORM
        // =================================================================
        const CompactStockForm = ({ onSave, initialStock }) => {
            const [codice, setCodice] = useState(initialStock?.codice || '');
            const [descrizione, setDescrizione] = useState(initialStock?.descrizione || '');
            const [quantity, setQuantity] = useState(initialStock?.quantity?.toString() || '1');
            const [price, setPrice] = useState(initialStock?.price?.toString() || '');
            const [date, setDate] = useState(initialStock?.date || new Date().toISOString().split('T')[0]);
            const [thumbnail, setThumbnail] = useState(initialStock?.thumbnail || '');
            const [fullImage, setFullImage] = useState(initialStock?.fullImage || '');
            const fileInputRef = useRef(null);

            const handleImageUpload = async (e) => {
                const file = e.target.files?.[0];
                if (!file || !file.type.startsWith('image/')) return;
                
                try {
                    const thumb = await resizeImage(file, 150, 150);
                    const full = await resizeImage(file, 1200, 1200);
                    setThumbnail(thumb);
                    setFullImage(full);
                } catch (error) {
                    console.error('Errore ridimensionamento immagine:', error);
                    alert('Errore nel caricamento dell\'immagine');
                }
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!codice || !descrizione || quantity === '') {
                    alert('Compila tutti i campi obbligatori');
                    return;
                }
                onSave({
                    id: initialStock?.id || new Date().toISOString() + Math.random(),
                    date,
                    codice: codice.toUpperCase(),
                    descrizione,
                    quantity: Number(quantity),
                    price: price === '' ? null : Number(price),
                    thumbnail,
                    fullImage
                });
            };

            return (
                <form onSubmit={handleSubmit} className="space-y-3">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Codice *</label>
                            <input 
                                type="text" 
                                value={codice} 
                                onChange={e => setCodice(e.target.value)} 
                                required 
                                disabled={!!initialStock?.id}
                                className="compact-input block w-full rounded border-slate-300 border focus:border-purple-500 focus:ring-1 focus:ring-purple-500 uppercase disabled:bg-slate-100" 
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Descrizione *</label>
                            <input type="text" value={descrizione} onChange={e => setDescrizione(e.target.value)} required className="compact-input block w-full rounded border-slate-300 border focus:border-purple-500 focus:ring-1 focus:ring-purple-500" />
                        </div>
                    </div>
                    <div className="grid grid-cols-3 gap-3">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Quantità *</label>
                            <input type="number" value={quantity} onChange={e => setQuantity(e.target.value)} required className="compact-input block w-full rounded border-slate-300 border focus:border-purple-500 focus:ring-1 focus:ring-purple-500" />
                            <p className="text-xs text-slate-500 mt-1">Usa negativi per scarichi</p>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Prezzo €</label>
                            <input type="number" value={price} onChange={e => setPrice(e.target.value)} min="0" step="0.01" placeholder="Opzionale" className="compact-input block w-full rounded border-slate-300 border focus:border-purple-500 focus:ring-1 focus:ring-purple-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Data *</label>
                            <input type="date" value={date} onChange={e => setDate(e.target.value)} required className="compact-input block w-full rounded border-slate-300 border focus:border-purple-500 focus:ring-1 focus:ring-purple-500" />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">Immagine (opzionale)</label>
                        <div className="border-2 border-dashed border-slate-300 rounded-lg p-4 text-center">
                            {thumbnail ? (
                                <div className="space-y-2">
                                    <img src={thumbnail} alt="Anteprima" className="mx-auto rounded" style={{ maxWidth: '120px' }} />
                                    <div className="flex justify-center gap-2">
                                        <button type="button" onClick={() => fileInputRef.current?.click()} className="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700">
                                            Cambia
                                        </button>
                                        <button type="button" onClick={() => { setThumbnail(''); setFullImage(''); }} className="px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">
                                            Rimuovi
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    <CameraIcon />
                                    <button type="button" onClick={() => fileInputRef.current?.click()} className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                                        Seleziona Immagine
                                    </button>
                                </div>
                            )}
                            <input 
                                ref={fileInputRef} 
                                type="file" 
                                accept="image/*" 
                                capture="environment" 
                                onChange={handleImageUpload} 
                                className="hidden" 
                            />
                        </div>
                    </div>
                    {quantity !== '' && price !== '' && !isNaN(Number(quantity)) && !isNaN(Number(price)) && (
                        <div className="bg-slate-50 p-3 rounded">
                            <span className="text-sm font-medium text-slate-600">Valore riga: </span>
                            <span className="text-lg font-bold text-slate-900">
                                {formatCurrency(Number(quantity) * Number(price))}
                            </span>
                        </div>
                    )}
                    <div className="flex justify-end gap-2 pt-2">
                        <button type="submit" className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2">
                            <SaveIcon /> {initialStock ? 'Aggiorna' : 'Salva'} Movimento
                        </button>
                    </div>
                </form>
            );
        };

        // =================================================================
        // COMPACT STOCK ITEM
        // =================================================================
        const CompactStockItem = ({ movement, totalQuantity, onEdit, onDelete, onImageClick }) => {
            const quantityColor = movement.quantity >= 0 ? 'text-green-600' : 'text-red-600';
            const total = movement.price !== null ? movement.quantity * movement.price : null;
            
            return (
                <div className="bg-white rounded shadow-sm compact-card hover:shadow-md transition-shadow">
                    <div className="flex items-start justify-between gap-3">
                        <div className="flex gap-3 flex-1 min-w-0">
                            {movement.thumbnail && (
                                <img 
                                    src={movement.thumbnail} 
                                    alt={movement.descrizione} 
                                    className="thumbnail-image flex-shrink-0" 
                                    onClick={() => onImageClick(movement.fullImage || movement.thumbnail)} 
                                />
                            )}
                            <div className="flex-1 min-w-0">
                                <div className="flex items-center gap-2 mb-1 flex-wrap">
                                    <h3 className="text-sm font-bold text-slate-800">{movement.codice}</h3>
                                    <span className={`text-sm font-bold ${quantityColor}`}>
                                        {movement.quantity > 0 ? `+${movement.quantity}` : movement.quantity}
                                    </span>
                                    <span className="text-xs text-slate-500">(Tot: {totalQuantity})</span>
                                </div>
                                <p className="text-xs text-slate-600 mb-1">{movement.descrizione}</p>
                                <div className="flex gap-3 text-xs text-slate-500 flex-wrap">
                                    <span>{formatDate(movement.date)}</span>
                                    {movement.price !== null && <span>€ {movement.price.toFixed(2)}</span>}
                                    {total !== null && <span className="font-semibold text-slate-900">{formatCurrency(total)}</span>}
                                </div>
                            </div>
                        </div>
                        <div className="flex gap-1 flex-shrink-0">
                            <button onClick={() => onEdit(movement)} className="p-2 text-purple-600 hover:bg-purple-50 rounded-full transition-colors" title="Modifica">
                                <EditIcon />
                            </button>
                            <button onClick={() => onDelete(movement.id)} className="p-2 text-red-600 hover:bg-red-50 rounded-full transition-colors" title="Elimina">
                                <TrashIcon />
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // =================================================================
        // STOCKS VIEW
        // =================================================================
        const StocksView = () => {
            const [stocks, setStocks, { isLoading, isSyncing }] = useGitHubStorage('stocks', []);
            const [showForm, setShowForm] = useState(false);
            const [editingStock, setEditingStock] = useState(null);
            const [lightboxImage, setLightboxImage] = useState(null);

            const handleSaveStock = (stockData) => {
                if (editingStock) {
                    setStocks(stocks.map(s => s.id === stockData.id ? stockData : s));
                } else {
                    setStocks([...stocks, stockData]);
                }
                setShowForm(false);
                setEditingStock(null);
            };

            const handleEdit = (stock) => {
                setEditingStock(stock);
                setShowForm(true);
            };

            const handleDeleteStock = (id) => {
                if (window.confirm("Eliminare questo movimento?")) {
                    setStocks(stocks.filter(s => s.id !== id));
                }
            };

            const handleCancel = () => {
                setShowForm(false);
                setEditingStock(null);
            };

            const aggregatedStocks = stocks.reduce((acc, stock) => {
                const key = stock.codice.toUpperCase();
                if (!acc[key]) {
                    acc[key] = { 
                        codice: stock.codice, 
                        totalQuantity: 0, 
                        descrizione: stock.descrizione,
                        thumbnail: stock.thumbnail
                    };
                }
                acc[key].totalQuantity += stock.quantity;
                if (!acc[key].thumbnail && stock.thumbnail) {
                    acc[key].thumbnail = stock.thumbnail;
                }
                return acc;
            }, {});

            const sortedMovements = [...stocks].sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

            const totalStats = Object.values(aggregatedStocks).reduce((acc, s) => {
                acc.uniqueItems += 1;
                acc.totalQuantity += s.totalQuantity;
                return acc;
            }, { uniqueItems: 0, totalQuantity: 0 });

            if (isLoading) {
                return <div className="text-center py-8 text-slate-600">Caricamento dati...</div>;
            }

            return (
                <div>
                    {isSyncing && (
                        <div className="mb-3 bg-purple-50 text-purple-700 px-3 py-2 rounded text-xs flex items-center gap-2">
                            <SyncIcon className="h-3 w-3 animate-spin" />
                            Sincronizzazione con GitHub...
                        </div>
                    )}

                    <div className="grid grid-cols-2 gap-3 mb-3">
                        <div className="bg-white rounded-lg shadow-sm p-3">
                            <p className="text-xs text-slate-600 mb-1">Articoli Unici</p>
                            <p className="text-2xl font-bold text-purple-600">{totalStats.uniqueItems}</p>
                        </div>
                        <div className="bg-white rounded-lg shadow-sm p-3">
                            <p className="text-xs text-slate-600 mb-1">Quantità Totale</p>
                            <p className="text-2xl font-bold text-slate-900">{totalStats.totalQuantity}</p>
                        </div>
                    </div>
                    
                    <button onClick={() => { setEditingStock(null); setShowForm(true); }} className="mb-3 w-full bg-purple-600 text-white rounded-lg py-3 hover:bg-purple-700 flex items-center justify-center gap-2 font-medium shadow-sm transition-colors">
                        <PlusIcon /> Nuovo Movimento
                    </button>

                    {sortedMovements.length > 0 ? (
                        <div className="space-y-2">
                            {sortedMovements.map(movement => (
                                <CompactStockItem 
                                    key={movement.id} 
                                    movement={movement} 
                                    totalQuantity={aggregatedStocks[movement.codice.toUpperCase()]?.totalQuantity || 0}
                                    onEdit={handleEdit} 
                                    onDelete={handleDeleteStock} 
                                    onImageClick={setLightboxImage}
                                />
                            ))}
                        </div>
                    ) : (
                        <div className="text-center py-16 bg-white rounded-lg shadow-sm">
                            <p className="text-slate-500">Nessun movimento presente</p>
                            <p className="text-slate-400 text-sm mt-1">Clicca "Nuovo Movimento" per iniziare</p>
                        </div>
                    )}

                    {showForm && (
                        <Modal title={editingStock ? "Modifica Movimento" : "Nuovo Movimento"} onClose={handleCancel}>
                            <CompactStockForm onSave={handleSaveStock} initialStock={editingStock} />
                        </Modal>
                    )}

                    {lightboxImage && <ImageLightbox imageUrl={lightboxImage} onClose={() => setLightboxImage(null)} />}
                </div>
            );
        };

        // =================================================================
        // GITHUB CONFIG PANEL
        // =================================================================
        const GitHubConfigPanel = ({ onClose }) => {
            const [owner, setOwner] = useState(GITHUB_CONFIG.owner);
            const [repo, setRepo] = useState(GITHUB_CONFIG.repo);
            const [token, setToken] = useState(GITHUB_CONFIG.token);

            const handleSave = () => {
                GITHUB_CONFIG.owner = owner;
                GITHUB_CONFIG.repo = repo;
                GITHUB_CONFIG.token = token;
                localStorage.setItem('github_config', JSON.stringify({ owner, repo, token }));
                alert('Configurazione salvata! Ricarica la pagina per applicare le modifiche.');
                onClose();
            };

            useEffect(() => {
                const saved = localStorage.getItem('github_config');
                if (saved) {
                    const config = JSON.parse(saved);
                    setOwner(config.owner || '');
                    setRepo(config.repo || '');
                    setToken(config.token || '');
                }
            }, []);

            return (
                <Modal title="Configurazione GitHub" onClose={onClose} maxWidth="max-w-md">
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Username GitHub</label>
                            <input type="text" value={owner} onChange={e => setOwner(e.target.value)} placeholder="tuonome" className="compact-input w-full rounded border-slate-300 border focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Nome Repository</label>
                            <input type="text" value={repo} onChange={e => setRepo(e.target.value)} placeholder="gestione-dati" className="compact-input w-full rounded border-slate-300 border focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">Personal Access Token</label>
                            <input type="password" value={token} onChange={e => setToken(e.target.value)} placeholder="ghp_..." className="compact-input w-full rounded border-slate-300 border focus:border-blue-500 focus:ring-1 focus:ring-blue-500" />
                            <p className="text-xs text-slate-500 mt-2">
                                Crea un token su GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)
                                <br/><strong>Permessi richiesti:</strong> repo
                            </p>
                        </div>
                        <div className="flex gap-2 pt-4">
                            <button onClick={onClose} className="flex-1 px-4 py-2 border border-slate-300 rounded hover:bg-slate-50">
                                Annulla
                            </button>
                            <button onClick={handleSave} className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                Salva
                            </button>
                        </div>
                    </div>
                </Modal>
            );
        };

        // =================================================================
        // MAIN APP
        // =================================================================
        const App = () => {
            const [activeTab, setActiveTab] = useState('orders');
            const [showConfig, setShowConfig] = useState(false);

            useEffect(() => {
                const saved = localStorage.getItem('github_config');
                if (saved) {
                    const config = JSON.parse(saved);
                    GITHUB_CONFIG.owner = config.owner || '';
                    GITHUB_CONFIG.repo = config.repo || '';
                    GITHUB_CONFIG.token = config.token || '';
                }
            }, []);

            const tabs = {
                orders: { label: 'Ordini', color: 'blue' },
                expenses: { label: 'Spese', color: 'emerald' },
                stocks: { label: 'Scorte', color: 'purple' }
            };

            return (
                <div className="min-h-screen bg-slate-100">
                    <header className="bg-white shadow-sm sticky top-0 z-40">
                        <div className="max-w-6xl mx-auto px-4 py-3">
                            <div className="flex items-center justify-between gap-4">
                                <h1 className="text-lg font-bold text-slate-900">Gestione Attività</h1>
                                <div className="flex gap-2">
                                    {Object.entries(tabs).map(([key, tab]) => (
                                        <button 
                                            key={key} 
                                            onClick={() => setActiveTab(key)} 
                                            className={`px-4 py-2 text-sm font-medium rounded-lg transition-colors ${
                                                activeTab === key 
                                                    ? `bg-${tab.color}-600 text-white shadow-sm` 
                                                    : 'bg-white text-slate-600 hover:bg-slate-100'
                                            }`}
                                        >
                                            {tab.label}
                                        </button>
                                    ))}
                                </div>
                                <button onClick={() => setShowConfig(true)} className="p-2 text-slate-500 hover:text-slate-700 hover:bg-slate-100 rounded-full transition-colors" title="Configura GitHub">
                                    <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-4">
                        {activeTab === 'orders' && <OrdersView />}
                        {activeTab === 'expenses' && <ExpensesView />}
                        {activeTab === 'stocks' && <StocksView />}
                    </main>

                    {showConfig && <GitHubConfigPanel onClose={() => setShowConfig(false)} />}
                </div>
            );
        };

        // =================================================================
        // RENDER
        // =================================================================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StrictMode><App /></StrictMode>);
    </script>
</body>
</html>